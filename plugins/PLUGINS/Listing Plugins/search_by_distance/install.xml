<?xml version="1.0" encoding="utf-8" ?>
<plugin name="search_by_distance">
	<title>Searching by distance</title>
	<description>Search by distance with geonames.org. Modified by mrx02de</description>
	<author>John Freeman</author>
	<owner>Flynax Classifieds Software</owner>
	<version>3.1.3</version>
	<date>31.01.2012</date>
	<controller>sbd_countries</controller>

	<files>
		<file>block.tpl</file>
		<file>distance.tpl</file>
		<file>distance_account.tpl</file>
		<file>paging.tpl</file>
		<file>rlSearchByDistance.class.php</file>
		<file>search.inc.php</file>
		<file>search.tpl</file>
		<file>static/lib.js</file>
		<file>static/style.css</file>
		<file>static/target.png</file>
		<file>admin/sbd_countries.inc.php</file>
		<file>admin/sbd_countries.tpl</file>
	</files>

	<install><![CDATA[
		global $rlDb, $reefless;

		$sql = "
		CREATE TABLE `".RL_DBPREFIX."sbd_countries` (
		`Code` VARCHAR( 2 ) NOT NULL ,
		`Status` ENUM( 'active', 'approval' ) COLLATE utf8_unicode_ci NOT NULL DEFAULT 'active',
		PRIMARY KEY ( `Code` )
		) DEFAULT CHARSET=utf8 ";

		$rlDb -> query($sql);

		$sql = "INSERT INTO `".RL_DBPREFIX."sbd_countries` (`Code`, `Status`) VALUES
		('AE', 'active'),
		('AU', 'active'),
		('BE', 'active'),
		('BR', 'active'),
		('CA', 'active'),
		('CH', 'active'),
		('DE', 'active'),
		('ES', 'active'),
		('FR', 'active'),
		('GR', 'active'),
		('IE', 'active'),
		('IT', 'active'),
		('PT', 'active'),
		('SA', 'active'),
		('TR', 'active'),
		('UK', 'active'),
		('US', 'active')";

		$rlDb -> query($sql);

		$reefless -> loadClass('Listings');
		$reefless -> loadClass( 'SearchByDistance', null, 'search_by_distance' );
		$GLOBALS['rlSearchByDistance'] -> updateBox();
	]]></install>

	<hooks>
		<hook name="listingAfterStats"><![CDATA[
			$GLOBALS['rlSmarty'] -> display(RL_ROOT . 'plugins' . RL_DS . 'search_by_distance' . RL_DS . 'distance.tpl');
		]]></hook>
		<hook version="3.0.0" name="accountAfterStats"><![CDATA[
			$GLOBALS['rlSmarty'] -> display(RL_ROOT . 'plugins' . RL_DS . 'search_by_distance' . RL_DS . 'distance_account.tpl');
		]]></hook>
		<hook name="tplHeader"><![CDATA[
			echo '<link href="'.RL_PLUGINS_URL.'search_by_distance/static/style.css" type="text/css" rel="stylesheet" />';
		]]></hook>
		<hook name="specialBlock"><![CDATA[
			global $block_keys, $reefless;

			if ( array_key_exists( 'search_by_distance', $block_keys ) )
			{
				$reefless -> loadClass('SearchByDistance', false, 'search_by_distance');
			}
		]]></hook>
		<hook version="3.0.0" name="apPhpConfigBottom"><![CDATA[
			global $rlDb, $lang, $configs, $reefless;

			$rlDb -> setTable('sbd_countries');
			$countries = $rlDb -> fetch('*', array('Status' => 'active'));

			if ( $countries )
			{
				$groupID = (int)$rlDb -> getOne('ID', "`Key` = 'search_by_distance' AND `Plugin` = 'search_by_distance'", 'config_groups');

				if ( !empty( $configs[$groupID] ) )
				{
					foreach( $configs[$groupID] as $key => $entry )
					{
						if ( $entry['Key'] == 'sbd_default_country' )
						{
							foreach ($countries as $cKey => $cValue)
							{
								$countries[$cKey]['ID'] = $cValue['Code'];
								$countries[$cKey]['name'] = $lang['sbd_countries+name+sbd_country_'. $cValue['Code'] ];
							}
							$configs[$groupID][$key]['Type'] = 'select';
							$configs[$groupID][$key]['Values'] = $countries;
						}
					}
				}
			}
		]]></hook>
		<hook name="listingsModifyFieldSearch"><![CDATA[
			global $sql, $reefless;

			$reefless -> loadClass('SearchByDistance', false, 'search_by_distance');
			$GLOBALS['rlSearchByDistance'] -> modifySqlSelect();

			$GLOBALS['aHooks']['search_by_distance'] = false;//hack for 4.0.1 version
		]]></hook>
		<hook name="listingsModifyWhereSearch"><![CDATA[
			$GLOBALS['rlSearchByDistance'] -> modifySqlWhere();
		]]></hook>
		<hook version="3.0.0" name="accountTypeTop"><![CDATA[
			$GLOBALS['aHooks']['search_by_distance'] = false;//hack for 4.0.1 version
		]]>
		</hook>
		<hook version="3.0.0" name="accountsSearchDealerSqlSelect"><![CDATA[
			global $sql, $reefless;

			$reefless -> loadClass('SearchByDistance', false, 'search_by_distance');
			$GLOBALS['rlSearchByDistance'] -> accountModifySqlSelect($param1, $param2);
		]]></hook>
		<hook version="3.0.0" name="accountsSearchDealerSqlWhere"><![CDATA[
			$GLOBALS['rlSearchByDistance'] -> accountModifySqlWhere($param1);
		]]></hook>
	</hooks>

	<phrases>
		<phrase key="sbd_mi" module="frontEnd"><![CDATA[Miles]]></phrase>
		<phrase key="sbd_mi_short" module="frontEnd"><![CDATA[Mi]]></phrase>
		<phrase key="sbd_km" module="frontEnd"><![CDATA[Kilometers]]></phrase>
		<phrase key="sbd_km_short" module="frontEnd"><![CDATA[Km]]></phrase>
		<phrase key="sbd_zipcode" module="frontEnd"><![CDATA[Zip Code]]></phrase>
		<phrase key="sbd_within" module="frontEnd"><![CDATA[within]]></phrase>
		<phrase key="sbd_distance" module="frontEnd"><![CDATA[Distance]]></phrase>
		<phrase key="sbd_select_country" module="frontEnd"><![CDATA[- Country -]]></phrase>
		<phrase key="sbd_search_limit_exceeded" module="frontEnd"><![CDATA[The encircled area on the map contains too many listings, please consider narrowing down your search radius]]></phrase>
		<phrase key="sbd_zip_not_found" module="frontEnd"><![CDATA[The zip code you have entered is missing in the database]]></phrase>
		<phrase key="sbd_location_not_found" module="frontEnd"><![CDATA[Failed to find your location]]></phrase>
		<phrase key="sbd_listing_unavailable" module="frontEnd"><![CDATA[Requested listing is unavailable]]></phrase>
		<phrase version="3.1.3" key="sbd_no_geoaccount" module="frontEnd"><![CDATA[Warning! No geoname.org account configured!]]></phrase>
		<phrase version="3.0.0" key="sbd_country_exists" module="admin"><![CDATA[The country you are trying to add is already in use]]></phrase>
		<phrase version="3.0.0" key="sbd_code_wrong" module="admin"><![CDATA[The country code is wrong, please use ISO code format, ex: US for United States]]></phrase>
		<phrase version="3.0.0" key="sbd_country_added_notice" module="admin"><![CDATA[New country has been successfully added]]></phrase>
		<phrase version="3.0.0" key="sbd_country_edited_notice" module="admin"><![CDATA[Country details has been successfully updated]]></phrase>
		<phrase version="3.0.0" key="sbd_add_country" module="admin"><![CDATA[Add Country]]></phrase>
		<phrase version="3.0.0" key="sbd_edit_country" module="admin"><![CDATA[Edit Country]]></phrase>
		<phrase version="3.0.0" key="sbd_country_code" module="admin"><![CDATA[Country ISO code]]></phrase>
		<phrase version="3.0.0" key="sbd_ext_country_code" module="ext"><![CDATA[Country Code]]></phrase>
		<phrase version="3.0.0" key="sbd_ext_caption" module="ext"><![CDATA[Countries]]></phrase>
		<phrase version="3.0.0" key="sbd_ext_country_name" module="ext"><![CDATA[Country Name]]></phrase>
		<phrase version="3.0.0" key="sbd_country_code_desc" module="admin"><![CDATA[ex: US for United States]]></phrase>
		<phrase version="3.0.0" key="sbd_countries+name+sbd_country_UK" module="common"><![CDATA[United Kingdom]]></phrase>
		<phrase version="3.0.0" key="sbd_countries+name+sbd_country_AE" module="common"><![CDATA[United Arab Emirates]]></phrase>
		<phrase version="3.0.0" key="sbd_countries+name+sbd_country_TR" module="common"><![CDATA[Turkey]]></phrase>
		<phrase version="3.0.0" key="sbd_countries+name+sbd_country_CH" module="common"><![CDATA[Switzerland]]></phrase>
		<phrase version="3.0.0" key="sbd_countries+name+sbd_country_ES" module="common"><![CDATA[Spain]]></phrase>
		<phrase version="3.0.0" key="sbd_countries+name+sbd_country_SA" module="common"><![CDATA[Saudi Arabia]]></phrase>
		<phrase version="3.0.0" key="sbd_countries+name+sbd_country_PT" module="common"><![CDATA[Portugal]]></phrase>
		<phrase version="3.0.0" key="sbd_countries+name+sbd_country_IT" module="common"><![CDATA[Italy]]></phrase>
		<phrase version="3.0.0" key="sbd_countries+name+sbd_country_IE" module="common"><![CDATA[Ireland]]></phrase>
		<phrase version="3.0.0" key="sbd_countries+name+sbd_country_GR" module="common"><![CDATA[Greece]]></phrase>
		<phrase version="3.0.0" key="sbd_countries+name+sbd_country_FR" module="common"><![CDATA[France]]></phrase>
		<phrase version="3.0.0" key="sbd_countries+name+sbd_country_DE" module="common"><![CDATA[Germany]]></phrase>
		<phrase version="3.0.0" key="sbd_countries+name+sbd_country_CA" module="common"><![CDATA[Canada]]></phrase>
		<phrase version="3.0.0" key="sbd_countries+name+sbd_country_BR" module="common"><![CDATA[Brazil]]></phrase>
		<phrase version="3.0.0" key="sbd_countries+name+sbd_country_BE" module="common"><![CDATA[Belgium]]></phrase>
		<phrase version="3.0.0" key="sbd_countries+name+sbd_country_AU" module="common"><![CDATA[Australia]]></phrase>
		<phrase version="3.0.0" key="sbd_countries+name+sbd_country_US" module="common"><![CDATA[United States]]></phrase>
	</phrases>

	<pages>
		<page key="search_by_distance" name="Search by Distance" type="system" path="search-by-distance" controller="search" tpl="1" menus="3"><![CDATA[]]></page>
	</pages>

	<blocks>
		<block version="3.0.0" key="search_by_distance" name="Search by Distance" side="left" type="PHP" tpl="1"><![CDATA[
			// the box content will be generated during plugin installation
		]]></block>
	</blocks>

	<configs key="search_by_distance" name="Search by Distance">
		<![CDATA[]]>
		<config key="sbd_common" name="Common Settings" type="divider"><![CDATA[1]]></config>
		<config key="sbd_geonames_user" name="Username at geoname.org" description="*Required! The username of your free geonames.org account" type="text"><![CDATA[]]></config>
		<config key="sbd_map_width" name="Map width" description="in pixels, leave empty to use 100% of page width" type="text" validate="int"><![CDATA[0]]></config>
		<config key="sbd_map_height" name="Map height" description="in pixels" type="text" validate="int"><![CDATA[280]]></config>
		<config key="sbd_distance_items" name="Distance range" type="text"><![CDATA[5,10,20,30,50,100]]></config>
		<config key="sbd_default_distance" name="Default distance" type="text"><![CDATA[10]]></config>
		<config key="sbd_units" name="Distance units" type="select" values="miles/kilometres,miles,kilometres"><![CDATA[miles/kilometres]]></config>
		<config key="sbd_default_units" name="Default unit" type="select" values="miles,kilometres"><![CDATA[miles]]></config>
		<config version="3.0.0" key="sbd_default_country" name="Default country" type="text"><![CDATA[US]]></config>
		<config key="sbd_listings" name="Listing Settings" type="divider"><![CDATA[1]]></config>
		<config key="sbd_listings_per_page" name="Listings per page" type="text" validate="int"><![CDATA[10]]></config>
		<config key="sbd_listings_limit" name="Single search limit" type="text" validate="int" description="listings"><![CDATA[200]]></config>
		<config version="3.0.0" key="sbd_listings_blank" name="Open listing details in a new window" type="bool"><![CDATA[0]]></config>
	</configs>

	<uninstall version="3.0.0"><![CDATA[
		global $rlDb;

		$rlDb -> query( "DROP TABLE `". RL_DBPREFIX ."sbd_countries`" );
	]]></uninstall>
</plugin>