(function(factory){if(typeof define==="function"&&define.amd)define(["jquery","tmpl","load-image","./jquery.fileupload-fp"],factory);else factory(window.jQuery,window.tmpl,window.loadImage)})(function($,tmpl,loadImage){$.widget("blueimp.fileupload",$.blueimp.fileupload,{options:{autoUpload:photo_auto_upload,maxNumberOfFiles:undefined,maxFileSize:undefined,minFileSize:undefined,acceptFileTypes:/.+$/i,previewSourceFileTypes:/^image\/(gif|jpeg|png)$/,previewSourceMaxFileSize:photo_max_size,previewMaxWidth:photo_width,
previewMaxHeight:photo_height,previewAsCanvas:true,uploadTemplateId:"template-upload",downloadTemplateId:"template-download",filesContainer:undefined,prependFiles:false,dataType:"json",add:function(e,data){var that=$(this).data("fileupload"),options=that.options,files=data.files;$(this).fileupload("process",data).done(function(){that._adjustMaxNumberOfFiles(-files.length);data.maxNumberOfFilesAdjusted=true;data.files.valid=data.isValidated=that._validate(files);if(!data.files.valid)return false;data.context=
that._renderUpload(files).data("data",data);options.filesContainer[options.prependFiles?"prepend":"append"](data.context);that._renderPreviews(files,data.context);that._forceReflow(data.context);that._transition(data.context).done(function(){if(that._trigger("added",e,data)!==false&&((options.autoUpload||data.autoUpload)&&(data.autoUpload!==false&&data.isValidated)))data.submit()})})},send:function(e,data){var that=$(this).data("fileupload");if(!data.isValidated){if(!data.maxNumberOfFilesAdjusted){that._adjustMaxNumberOfFiles(-data.files.length);
data.maxNumberOfFilesAdjusted=true}if(!that._validate(data.files))return false}if(data.context&&(data.dataType&&data.dataType.substr(0,6)==="iframe"))data.context.find(".progress").addClass(!$.support.transition&&"progress-animated").attr("aria-valuenow",100).find(".bar").css("width","100%");return that._trigger("sent",e,data)},done:function(e,data){var that=$(this).data("fileupload"),template;if(data.context){data.context.each(function(index){var file=$.isArray(data.result)&&data.result[index]||
{error:"Empty file upload result"};if(file.error)that._adjustMaxNumberOfFiles(1);that._transition($(this)).done(function(){var node=$(this);template=that._renderDownload([file]).replaceAll(node);that._forceReflow(template);that._transition(template).done(function(){data.context=$(this);that._trigger("completed",e,data);managePhotoDesc();crop_handler()})})});$("#fileupload input.start").val(lang["upload"]);printMessage("notice",lang["uploading_completed"])}else{if($.isArray(data.result)){$.each(data.result,
function(index,file){if(data.maxNumberOfFilesAdjusted&&file.error)that._adjustMaxNumberOfFiles(1);else if(!data.maxNumberOfFilesAdjusted&&!file.error)that._adjustMaxNumberOfFiles(-1)});data.maxNumberOfFilesAdjusted=true}template=that._renderDownload(data.result).appendTo(that.options.filesContainer);that._forceReflow(template);that._transition(template).done(function(){data.context=$(this);that._trigger("completed",e,data)})}},fail:function(e,data){var that=$(this).data("fileupload"),template;if(data.maxNumberOfFilesAdjusted)that._adjustMaxNumberOfFiles(data.files.length);
if(data.context)data.context.each(function(index){if(data.errorThrown!=="abort"){var file=data.files[index];file.error=file.error||(data.errorThrown||true);that._transition($(this)).done(function(){var node=$(this);template=that._renderDownload([file]).replaceAll(node);that._forceReflow(template);that._transition(template).done(function(){data.context=$(this);that._trigger("failed",e,data)})})}else that._transition($(this)).done(function(){$(this).remove();that._trigger("failed",e,data)})});else if(data.errorThrown!==
"abort"){data.context=that._renderUpload(data.files).appendTo(that.options.filesContainer).data("data",data);that._forceReflow(data.context);that._transition(data.context).done(function(){data.context=$(this);that._trigger("failed",e,data)})}else that._trigger("failed",e,data)},progress:function(e,data){if(data.context){var progress=parseInt(data.loaded/data.total*100,10);data.context.find(".progress").attr("aria-valuenow",progress).find(".bar").css("width",progress+"%")}},progressall:function(e,
data){var $this=$(this),progress=parseInt(data.loaded/data.total*100,10),globalProgressNode=$this.find(".fileupload-progress"),extendedProgressNode=globalProgressNode.find(".progress-extended");if(extendedProgressNode.length)extendedProgressNode.html($this.data("fileupload")._renderExtendedProgress(data));globalProgressNode.find(".progress").attr("aria-valuenow",progress).find(".bar").css("width",progress+"%")},start:function(e){var that=$(this).data("fileupload");that._transition($(this).find(".fileupload-progress")).done(function(){that._trigger("started",
e)})},stop:function(e){var that=$(this).data("fileupload");that._transition($(this).find(".fileupload-progress")).done(function(){$(this).find(".progress").attr("aria-valuenow","0").find(".bar").css("width","0%");$(this).find(".progress-extended").html("&nbsp;");that._trigger("stopped",e)})},destroy:function(e,data){var that=$(this).data("fileupload");if(data.url){$.ajax(data);that._adjustMaxNumberOfFiles(1)}that._transition(data.context).done(function(){$(this).remove();that._trigger("destroyed",
e,data)})}},_enableDragToDesktop:function(){var link=$(this),url=link.prop("href"),name=link.prop("download"),type="application/octet-stream";link.bind("dragstart",function(e){try{e.originalEvent.dataTransfer.setData("DownloadURL",[type,name,url].join(":"))}catch(err){}})},_adjustMaxNumberOfFiles:function(operand){if(typeof this.options.maxNumberOfFiles==="number"){if(operand<0&&this.options.maxNumberOfFiles<0)return;if(operand>0&&this.options.maxNumberOfFiles<0)this.options.maxNumberOfFiles=0;this.options.maxNumberOfFiles+=
operand;if(this.options.maxNumberOfFiles<1)this._disableFileInputButton();else this._enableFileInputButton();$("span.draft span.allowed b").html(this.options.maxNumberOfFiles)}},_formatFileSize:function(bytes){if(typeof bytes!=="number")return"";if(bytes>=1E9)return(bytes/1E9).toFixed(2)+" GB";if(bytes>=1E6)return(bytes/1E6).toFixed(2)+" MB";return(bytes/1E3).toFixed(2)+" KB"},_formatBitrate:function(bits){if(typeof bits!=="number")return"";if(bits>=1E9)return(bits/1E9).toFixed(2)+" Gbit/s";if(bits>=
1E6)return(bits/1E6).toFixed(2)+" Mbit/s";if(bits>=1E3)return(bits/1E3).toFixed(2)+" kbit/s";return bits+" bit/s"},_formatTime:function(seconds){var date=new Date(seconds*1E3),days=parseInt(seconds/86400,10);days=days?days+"d ":"";return days+("0"+date.getUTCHours()).slice(-2)+":"+("0"+date.getUTCMinutes()).slice(-2)+":"+("0"+date.getUTCSeconds()).slice(-2)},_formatPercentage:function(floatValue){return(floatValue*100).toFixed(2)+" %"},_renderExtendedProgress:function(data){return this._formatBitrate(data.bitrate)+
" | "+this._formatTime((data.total-data.loaded)*8/data.bitrate)+" | "+this._formatPercentage(data.loaded/data.total)+" | "+this._formatFileSize(data.loaded)+" / "+this._formatFileSize(data.total)},_hasError:function(file){if(file.error)return file.error;if(this.options.maxNumberOfFiles<0)return"Maximum number of files exceeded";if(!(this.options.acceptFileTypes.test(file.type)||this.options.acceptFileTypes.test(file.name))){printMessage("error",lang["error_acceptFileTypes"]);return"Filetype not allowed"}if(this.options.maxFileSize&&
file.size>this.options.maxFileSize){printMessage("error",lang["error_maxFileSize"]);return"File is too big"}if(typeof file.size==="number"&&file.size<this.options.minFileSize)return"File is too small";return null},_validate:function(files){var that=this,valid=!!files.length;$.each(files,function(index,file){file.error=that._hasError(file);if(file.error)valid=false});return valid},_renderTemplate:function(func,files){if(!func)return $();var result=func({files:files,formatFileSize:this._formatFileSize,
options:this.options});if(result instanceof $)return result;return $(this.options.templatesContainer).html(result).children()},_renderPreview:function(file,node){var that=this,options=this.options,dfd=$.Deferred();return(loadImage&&loadImage(file,function(img){node.append(img);that._forceReflow(node);that._transition(node).done(function(){dfd.resolveWith(node)});if(!$.contains(that.document[0].body,node[0]))dfd.resolveWith(node)},{maxWidth:options.previewMaxWidth,maxHeight:options.previewMaxHeight,
canvas:options.previewAsCanvas})||dfd.resolveWith(node))&&dfd},_renderPreviews:function(files,nodes){var that=this,options=this.options;nodes.find(".preview span").each(function(index,element){var file=files[index];if(options.previewSourceFileTypes.test(file.type)&&($.type(options.previewSourceMaxFileSize)!=="number"||file.size<options.previewSourceMaxFileSize))that._processingQueue=that._processingQueue.pipe(function(){var dfd=$.Deferred();that._renderPreview(file,$(element)).done(function(){$("#fileupload input.start").val(lang["upload"]);
dfd.resolveWith(that)});return dfd.promise()});else $(this).html('<div class="canvas"><div style="width: 120px;height: 90px;text-align: center;"><br />'+lang["upload_file"]+" <b>"+file.name+"</b><br /><br />"+lang["upload_no_preview_available"]+"</div></div>")});$("#fileupload input.start").val(lang["upload"]);return this._processingQueue},_renderUpload:function(files){return this._renderTemplate(this.options.uploadTemplate,files)},_renderDownload:function(files){return this._renderTemplate(this.options.downloadTemplate,
files).find("a[download]").each(this._enableDragToDesktop).end()},_startHandler:function(e){$("#fileupload input.start").val(lang["loading"]);e.preventDefault();var button=$(e.currentTarget),template=button.closest(".template-upload"),data=template.data("data");if(data&&(data.submit&&(!data.jqXHR&&data.submit())))button.prop("disabled",true)},_cancelHandler:function(e){e.preventDefault();var template=$(e.currentTarget).closest(".template-upload"),data=template.data("data")||{};if(!data.jqXHR){data.errorThrown=
"abort";this._trigger("fail",e,data)}else data.jqXHR.abort()},_deleteHandler:function(e){e.preventDefault();var button=$(e.currentTarget);this._trigger("destroy",e,$.extend({context:button.closest(".template-download"),type:"DELETE",dataType:this.options.dataType},button.data()))},_forceReflow:function(node){return $.support.transition&&(node.length&&node[0].offsetWidth)},_transition:function(node){var dfd=$.Deferred();if($.support.transition&&node.hasClass("fade"))node.bind($.support.transition.end,
function(e){if(e.target===node[0]){node.unbind($.support.transition.end);dfd.resolveWith(node)}}).toggleClass("in");else{node.toggleClass("in");dfd.resolveWith(node)}return dfd},_initButtonBarEventHandlers:function(){var fileUploadButtonBar=this.element,filesList=this.options.filesContainer;this._on(fileUploadButtonBar.find(".start"),{click:function(e){e.preventDefault();filesList.find(".start").click()}});this._on(fileUploadButtonBar.find(".cancel"),{click:function(e){e.preventDefault();filesList.find(".cancel").click()}});
this._on(fileUploadButtonBar.find(".delete"),{click:function(e){e.preventDefault();filesList.find(".delete input:checked").siblings("button").click();fileUploadButtonBar.find(".toggle").prop("checked",false)}});this._on(fileUploadButtonBar.find(".toggle"),{change:function(e){filesList.find(".delete input").prop("checked",$(e.currentTarget).is(":checked"))}})},_destroyButtonBarEventHandlers:function(){this._off(this.element.find(".fileupload-buttonbar button"),"click");this._off(this.element.find(".fileupload-buttonbar .toggle"),
"change.")},_initEventHandlers:function(){this._super();this._on(this.options.filesContainer,{"click .start":this._startHandler,"click .cancel":this._cancelHandler,"click .delete":this._deleteHandler});this._initButtonBarEventHandlers()},_destroyEventHandlers:function(){this._destroyButtonBarEventHandlers();this._off(this.options.filesContainer,"click");this._super()},_enableFileInputButton:function(){$("span.draft").fadeIn()},_disableFileInputButton:function(){$("span.draft").fadeOut()},_initTemplates:function(){var options=
this.options;options.templatesContainer=this.document[0].createElement(options.filesContainer.prop("nodeName"));if(tmpl){if(options.uploadTemplateId)options.uploadTemplate=tmpl(options.uploadTemplateId);if(options.downloadTemplateId)options.downloadTemplate=tmpl(options.downloadTemplateId)}},_initFilesContainer:function(){var options=this.options;if(options.filesContainer===undefined)options.filesContainer=this.element.find(".files");else if(!(options.filesContainer instanceof $))options.filesContainer=
$(options.filesContainer)},_stringToRegExp:function(str){var parts=str.split("/"),modifiers=parts.pop();parts.shift();return new RegExp(parts.join("/"),modifiers)},_initRegExpOptions:function(){var options=this.options;if($.type(options.acceptFileTypes)==="string")options.acceptFileTypes=this._stringToRegExp(options.acceptFileTypes);if($.type(options.previewSourceFileTypes)==="string")options.previewSourceFileTypes=this._stringToRegExp(options.previewSourceFileTypes)},_initSpecialOptions:function(){this._super();
this._initFilesContainer();this._initTemplates();this._initRegExpOptions()},_create:function(){this._super();this._refreshOptionsList.push("filesContainer","uploadTemplateId","downloadTemplateId");if(!this._processingQueue){this._processingQueue=$.Deferred().resolveWith(this).promise();this.process=function(){return this._processingQueue}}},enable:function(){var wasDisabled=false;if(this.options.disabled)wasDisabled=true;this._super();if(wasDisabled){this.element.find("input, button").prop("disabled",
false);this._enableFileInputButton()}},disable:function(){if(!this.options.disabled){this.element.find("input, button").prop("disabled",true);this._disableFileInputButton()}this._super()}})});